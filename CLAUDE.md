# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Hysteria ORM is a modern, partially type-safe Object Relational Mapper for Node.js that supports multiple SQL databases (PostgreSQL, MySQL, SQLite, MariaDB, CockroachDB, Microsoft SQL Server, Oracle DB) and experimental NoSQL databases (MongoDB, Redis). The project is under active development and not production-ready.

**Key Technical Details:**
- Language: TypeScript (ESM)
- Runtime: Node.js 22.x
- Package Manager: Yarn
- Build Tool: tsup
- Testing Framework: Jest with ts-jest

## Development Commands

### Build and Format
```bash
yarn build              # Production build (minified)
yarn build:dev          # Development build
yarn format             # Format with Prettier
```

### Testing
```bash
yarn test               # Run all tests via custom test runner
yarn test:with:migrations  # Fresh test with migrations (rebuilds SQLite db)
```

### Custom Test Runner (`node ./test/test_runner.js`)
The test runner supports advanced options for multi-database testing:
```bash
# Run tests for specific database(s)
node ./test/test_runner.js -d mysql postgres

# Run specific test file(s)
node ./test/test_runner.js -f query_builder.test.ts

# Run specific test case(s) (passed to Jest -t)
node ./test/test_runner.js -t "should select users"

# Enable database query logs
node ./test/test_runner.js -l
```

**Supported databases:** `mysql`, `sqlite`, `mariadb`, `postgres`, `cockroachdb`, `mssql`

### Migrations
```bash
yarn generate:migrations    # Generate migration files from models
yarn run:migrations         # Run migrations
yarn refresh:migrations     # Drop all tables and re-run migrations
yarn migrate               # Run migrations (legacy command)
```

### CLI
```bash
yarn build && node lib/cli.js [command]
hysteria [command]         # After installing globally
```

## Architecture

### Entry Points
- `src/index.ts` - Main library entry point, exports public API
- `src/cli.ts` - CLI entry point (built as standalone executable)

### Core Architecture

```
src/
├── sql/                    # SQL database implementation
│   ├── models/            # Model decorators and definitions
│   ├── query_builder/     # Fluent query builder API
│   ├── migrations/        # Migration system (diff, generate, run)
│   ├── seeders/          # Data seeding
│   ├── interpreter/       # Database-specific SQL interpreters
│   ├── ast/              # Abstract Syntax Tree for SQL
│   ├── sql_data_source.ts # Main SQL data source (54KB, core)
│   └── serializer.ts      # Result serialization
├── drivers/               # Database driver abstractions
├── data_source/           # Base data source interfaces
├── cache/                 # Caching layer (in-memory, Redis, SQL)
├── cli/                   # CLI command implementations
├── no_sql/               # NoSQL implementations (MongoDB, Redis)
├── adminjs/              # AdminJS integration
├── openapi/              # OpenAPI support
└── utils/                # Utilities
```

### Key Architectural Patterns

**1. Model Definition via Decorators**
Models are defined using TypeScript decorators (`@Model`, `@Column`, `@Relation`, etc.) located in `src/sql/models/`. The decorators store metadata that the query builder and migration system use.

**2. Interpreter Pattern**
Each database has a dedicated interpreter in `src/sql/interpreter/` that translates the ORM's AST into database-specific SQL. The interpreter mapping is generated by `scripts/generate_interpreter_map.js` before building.

**3. Query Builder**
The query builder (`src/sql/query_builder/`) provides a fluent API for constructing queries. It builds an AST that interpreters then convert to database-specific SQL.

**Type Safety in the Query Builder:**
- **Select**: Return type narrows based on selected columns via `BuildSelectType<T, Columns>`. The `S` generic on `ModelQueryBuilder<T, S, R>` tracks selected columns, and `R` tracks loaded relations.
- **Where clauses**: `where`, `whereIn`, `whereBetween`, and `having` methods use `<K extends ModelKey<T>>` overloads so the value parameter is inferred from the column's type (e.g., `where("age", 25)` enforces `number`). Fallback overloads with `BaseValues` remain for raw/joined columns.
- **Aggregates**: `getCount`, `getMax`, `getMin`, `getAvg`, `getSum` in `ModelQueryBuilder` accept `ModelKey<T> & string` for intellisense while still allowing arbitrary strings.
- **Key type utilities**: `ModelKey<T>` (excludes relations/methods), `WhereColumnValue<T, K>` (column value type + null), `BuildSelectType`, `ComposeBuildSelect`, `SelectBrand`.

**4. Migration System**
Migrations work by:
1. Reading model decorator metadata
2. Comparing against database schema (introspection)
3. Generating diff SQL via database-specific schema management
4. Running migrations via versioned migration files

**5. Data Source Abstraction**
- `BaseDataSource` (in `data_source/`) - Base interface
- `SqlDataSource` (in `sql/sql_data_source.ts`) - SQL implementation
- NoSQL data sources for MongoDB/Redis

### Multi-Database Support
Database drivers are **peer dependencies** (optional). Users install only the drivers they need. The ORM detects available drivers and configures accordingly.

## Test Organization

Tests are organized by database type and feature:
- `test/sql/` - SQL-specific tests (query builder, relations, transactions, etc.)
- `test/mongo/` - MongoDB tests
- `test/redis/` - Redis tests
- `test/cache/` - Caching tests
- `test/replication/` - Read replica tests

Tests are designed to run against multiple database backends. The custom test runner (`test/test_runner.js`) orchestrates running SQL tests across all configured database environments.

## Important Implementation Notes

**1. Interpreter Map Generation**
Before building, you must run `yarn generate:interpreter:map` which executes `generate_interpreter_map.js`. This creates a mapping of database types to their interpreter classes.

**2. External Dependencies**
The build configures these dependencies as external (not bundled):
- Database drivers: `pg`, `mysql2`, `sqlite3`, `ioredis`, `mongodb`, `mssql`, `oracledb`
- Utilities: `sql-formatter`, `sql-highlight`, `dayjs`, `commander`

**3. Module Format**
The project outputs both ESM (`lib/index.js`) and CJS (`lib/index.cjs`) with TypeScript definitions (`lib/index.d.ts`).

**4. Test Isolation**
Tests use a custom runner (not standard Jest) because they need to:
- Run the same tests against multiple database backends
- Set up database-specific environments via environment variables
- Support Docker-based test databases

**5. BigInt Primary Key Limitation**
CockroachDB does not support `bigint` primary keys in the same way as other databases. Tests involving `bigint_pk` are skipped for CockroachDB.

## Database Configuration for Testing

Test databases are configured in `test/test_environments.js`. Environment variables control database connections:
- `DB_TYPE` - Database type
- `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_DATABASE` - Connection details
- `DB_LOGS` - Enable query logging
- `MSSQL_TRUST_SERVER_CERTIFICATE` - SQL Server specific option

Tests typically require Docker containers for databases (except SQLite).
