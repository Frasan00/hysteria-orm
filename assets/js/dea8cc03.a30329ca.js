"use strict";(self.webpackChunkhysteria_orm_docs=self.webpackChunkhysteria_orm_docs||[]).push([[4648],{3192:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>t});const s=JSON.parse('{"id":"databases/sql/cli/migrations/advanced","title":"Advanced Migration Patterns","description":"Explore advanced migration features and patterns in Hysteria ORM.","source":"@site/docs/databases/sql/cli/migrations/advanced.md","sourceDirName":"databases/sql/cli/migrations","slug":"/databases/sql/cli/migrations/advanced","permalink":"/hysteria-orm/databases/sql/cli/migrations/advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/Frasan00/hysteria-orm/tree/main/website/docs/databases/sql/cli/migrations/advanced.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Advanced Migration Patterns","sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Migration Templates","permalink":"/hysteria-orm/databases/sql/cli/migrations/templates"},"next":{"title":"Generate (experimental)","permalink":"/hysteria-orm/databases/sql/cli/migrations/experimental-generate-migrations"}}');var r=i(4848),l=i(8453);const o={title:"Advanced Migration Patterns",sidebar_position:6},c="Advanced Migration Patterns",a={},t=[{value:"Advisory Locking",id:"advisory-locking",level:2},{value:"Overview",id:"overview",level:3},{value:"Database Support",id:"database-support",level:3},{value:"Configuration",id:"configuration",level:3},{value:"CLI Usage",id:"cli-usage",level:3},{value:"Programmatic Usage",id:"programmatic-usage",level:3},{value:"Lock Behavior",id:"lock-behavior",level:3},{value:"API Reference",id:"api-reference",level:3},{value:"<code>acquireLock(lockKey?, timeoutMs?)</code>",id:"acquirelocklockkey-timeoutms",level:4},{value:"<code>releaseLock(lockKey?)</code>",id:"releaselocklockkey",level:4},{value:"Database-Specific Notes",id:"database-specific-notes",level:3},{value:"PostgreSQL/CockroachDB",id:"postgresqlcockroachdb",level:4},{value:"MySQL/MariaDB",id:"mysqlmariadb",level:4},{value:"MSSQL",id:"mssql",level:4},{value:"Oracle",id:"oracle",level:4},{value:"SQLite",id:"sqlite",level:4},{value:"Best Practices",id:"best-practices",level:3},{value:"Disabling Locks",id:"disabling-locks",level:3},{value:"Hooks and Lifecycle",id:"hooks-and-lifecycle",level:2},{value:"Programmatic Control",id:"programmatic-control",level:2},{value:"Schema Builder API",id:"schema-builder-api",level:2},{value:"Tips",id:"tips",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"advanced-migration-patterns",children:"Advanced Migration Patterns"})}),"\n",(0,r.jsx)(n.p,{children:"Explore advanced migration features and patterns in Hysteria ORM."}),"\n",(0,r.jsx)(n.h2,{id:"advisory-locking",children:"Advisory Locking"}),"\n",(0,r.jsx)(n.p,{children:"Hysteria ORM includes built-in advisory locking to prevent concurrent migrations from running simultaneously. This is critical in production environments where multiple application instances might attempt to run migrations at the same time."}),"\n",(0,r.jsx)(n.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:"By default, all migration commands acquire an advisory lock before executing. This ensures that only one migration process can run at a time, preventing race conditions, duplicate migrations, and database corruption."}),"\n",(0,r.jsx)(n.h3,{id:"database-support",children:"Database Support"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Database"}),(0,r.jsx)(n.th,{children:"Lock Mechanism"}),(0,r.jsx)(n.th,{children:"Status"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"PostgreSQL"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"pg_advisory_lock()"})," / ",(0,r.jsx)(n.code,{children:"pg_advisory_unlock()"})]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"CockroachDB"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"pg_advisory_lock()"})," / ",(0,r.jsx)(n.code,{children:"pg_advisory_unlock()"})]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"MySQL"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"GET_LOCK()"})," / ",(0,r.jsx)(n.code,{children:"RELEASE_LOCK()"})]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"MariaDB"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"GET_LOCK()"})," / ",(0,r.jsx)(n.code,{children:"RELEASE_LOCK()"})]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"MSSQL"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"sp_getapplock"})," / ",(0,r.jsx)(n.code,{children:"sp_releaseapplock"})]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Oracle"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"DBMS_LOCK"})," package"]}),(0,r.jsx)(n.td,{children:"\u2705 Supported"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"SQLite"}),(0,r.jsx)(n.td,{children:"File-based locking (automatic)"}),(0,r.jsx)(n.td,{children:"\u2705 Built-in"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["You can configure locking behavior in your ",(0,r.jsx)(n.code,{children:"SqlDataSource"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const sqlDs = new SqlDataSource({\n  type: 'postgres',\n  // ... connection config\n  migrations: {\n    path: 'database/migrations',\n    lock: true,  // Enable advisory locking (default)\n  },\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"cli-usage",children:"CLI Usage"}),"\n",(0,r.jsxs)(n.p,{children:["All migration commands support the ",(0,r.jsx)(n.code,{children:"--lock"})," option (enabled by default):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Run migrations with locking (default behavior)\nhysteria-orm run:migrations -d ./database/index.ts\n\n# Disable locking (not recommended for production)\nhysteria-orm run:migrations -d ./database/index.ts --no-lock\n\n# Other commands also support locking\nhysteria-orm rollback:migrations -d ./database/index.ts\nhysteria-orm refresh:migrations -d ./database/index.ts\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Priority"}),": CLI flags override SqlDataSource configuration."]}),"\n",(0,r.jsx)(n.h3,{id:"programmatic-usage",children:"Programmatic Usage"}),"\n",(0,r.jsx)(n.p,{children:"The lock methods are generic and can be used for any purpose beyond migrations:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { SqlDataSource } from 'hysteria-orm';\n\nconst sqlDs = new SqlDataSource({\n  type: 'postgres',\n  // ... connection config\n});\n\nawait sqlDs.connect();\n\n// Acquire a lock for migrations\nconst migrationLock = await sqlDs.acquireLock('hysteria_migration_lock');\nif (migrationLock) {\n  try {\n    // Run your migrations\n    await runMigrationsConnector(sqlDs, undefined, migrationPath);\n  } finally {\n    // Always release in finally block\n    await sqlDs.releaseLock('hysteria_migration_lock');\n  }\n} else {\n  console.error('Could not acquire migration lock');\n}\n\n// Use custom lock keys for other operations\nconst jobLock = await sqlDs.acquireLock('background_job_lock', 60000); // 60s timeout\nif (jobLock) {\n  try {\n    // Run background job\n  } finally {\n    await sqlDs.releaseLock('background_job_lock');\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lock-behavior",children:"Lock Behavior"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Lock Acquisition"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Default lock key for migrations: ",(0,r.jsx)(n.code,{children:"hysteria_migration_lock"})]}),"\n",(0,r.jsx)(n.li,{children:"Default timeout: 30 seconds (configurable)"}),"\n",(0,r.jsx)(n.li,{children:"If lock cannot be acquired, the operation fails immediately"}),"\n",(0,r.jsxs)(n.li,{children:["Non-blocking: returns ",(0,r.jsx)(n.code,{children:"false"})," if lock is held by another process"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Lock Release"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Always released in ",(0,r.jsx)(n.code,{children:"finally"})," blocks"]}),"\n",(0,r.jsx)(n.li,{children:"Automatic release on successful completion"}),"\n",(0,r.jsx)(n.li,{children:"Automatic release on error/exception"}),"\n",(0,r.jsx)(n.li,{children:"Warnings logged if release fails"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Refresh Command"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Acquires lock once at the start"}),"\n",(0,r.jsx)(n.li,{children:"Maintains lock for both rollback and run operations"}),"\n",(0,r.jsx)(n.li,{children:"Prevents double-locking across internal operations"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsx)(n.h4,{id:"acquirelocklockkey-timeoutms",children:(0,r.jsx)(n.code,{children:"acquireLock(lockKey?, timeoutMs?)"})}),"\n",(0,r.jsx)(n.p,{children:"Acquires an advisory lock."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lockKey"})," (string, optional): Lock identifier. Defaults to ",(0,r.jsx)(n.code,{children:"'hysteria_lock'"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"timeoutMs"})," (number, optional): Maximum wait time in milliseconds. Defaults to ",(0,r.jsx)(n.code,{children:"30000"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Returns:"})," ",(0,r.jsx)(n.code,{children:"Promise<boolean>"})," - ",(0,r.jsx)(n.code,{children:"true"})," if lock acquired, ",(0,r.jsx)(n.code,{children:"false"})," otherwise"]}),"\n",(0,r.jsx)(n.h4,{id:"releaselocklockkey",children:(0,r.jsx)(n.code,{children:"releaseLock(lockKey?)"})}),"\n",(0,r.jsx)(n.p,{children:"Releases an advisory lock."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"lockKey"})," (string, optional): Lock identifier. Defaults to ",(0,r.jsx)(n.code,{children:"'hysteria_lock'"})]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Returns:"})," ",(0,r.jsx)(n.code,{children:"Promise<boolean>"})," - ",(0,r.jsx)(n.code,{children:"true"})," if lock released, ",(0,r.jsx)(n.code,{children:"false"})," otherwise"]}),"\n",(0,r.jsx)(n.h3,{id:"database-specific-notes",children:"Database-Specific Notes"}),"\n",(0,r.jsx)(n.h4,{id:"postgresqlcockroachdb",children:"PostgreSQL/CockroachDB"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Uses session-level advisory locks"}),"\n",(0,r.jsx)(n.li,{children:"Automatically released when connection closes"}),"\n",(0,r.jsxs)(n.li,{children:["Non-blocking with ",(0,r.jsx)(n.code,{children:"pg_try_advisory_lock()"})]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"mysqlmariadb",children:"MySQL/MariaDB"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Named locks with timeout support"}),"\n",(0,r.jsx)(n.li,{children:"Locks are session-specific"}),"\n",(0,r.jsx)(n.li,{children:"Automatically released on connection close"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"mssql",children:"MSSQL"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Application locks with session ownership"}),"\n",(0,r.jsx)(n.li,{children:"Supports immediate failure or timeout"}),"\n",(0,r.jsx)(n.li,{children:"Return codes: \u22650 = success, <0 = failure"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"oracle",children:"Oracle"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.code,{children:"DBMS_LOCK"})," package (requires execute permission)"]}),"\n",(0,r.jsxs)(n.li,{children:["Lock handle allocated via ",(0,r.jsx)(n.code,{children:"ALLOCATE_UNIQUE"})]}),"\n",(0,r.jsx)(n.li,{children:"Exclusive mode (X_MODE) for migrations"}),"\n",(0,r.jsx)(n.li,{children:"Explicit release required (not auto-released)"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"sqlite",children:"SQLite"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"File-based locking is automatic"}),"\n",(0,r.jsx)(n.li,{children:"No explicit advisory locks needed"}),"\n",(0,r.jsx)(n.li,{children:"Lock operations return success immediately"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Always Use Locking in Production"}),": Keep the default behavior enabled"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Custom Lock Keys"}),": Use different lock keys for different operation types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Timeout Configuration"}),": Increase timeout for slow database operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor Lock Failures"}),": Set up alerts for lock acquisition failures"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database Permissions"}),": Ensure database users have lock-related permissions"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"disabling-locks",children:"Disabling Locks"}),"\n",(0,r.jsx)(n.p,{children:"While not recommended for production, you can disable locking:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# CLI\nhysteria-orm run:migrations --no-lock -d ./database/index.ts\n\n# Programmatic\nawait runMigrationsConnector(\n  sqlDs,\n  undefined, // runUntil\n  undefined, // migrationPath\n  undefined, // tsconfigPath\n  true,      // transactional\n  false      // useLock - DISABLED\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"hooks-and-lifecycle",children:"Hooks and Lifecycle"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"afterMigration"}),": Run logic after a migration completes (see ",(0,r.jsx)(n.code,{children:"Migration"})," class)."]}),"\n",(0,r.jsx)(n.li,{children:"Custom hooks for pre/post migration logic."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"programmatic-control",children:"Programmatic Control"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Run migrations up/down to a specific migration."}),"\n",(0,r.jsx)(n.li,{children:"Use custom migration paths for multi-tenant or modular apps."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"schema-builder-api",children:"Schema Builder API"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use advanced column types, constraints, and raw queries."}),"\n",(0,r.jsxs)(n.li,{children:["Compose complex schema changes with ",(0,r.jsx)(n.code,{children:"alterTable"}),", ",(0,r.jsx)(n.code,{children:"renameColumn"}),", etc."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"tips",children:"Tips"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Keep migrations atomic and focused."}),"\n",(0,r.jsx)(n.li,{children:"Use version control for migration files."}),"\n",(0,r.jsx)(n.li,{children:"Document intent in migration comments."}),"\n",(0,r.jsx)(n.li,{children:"Always use advisory locking in production environments."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.code,{children:"src/sql/migrations/migration.ts"})," and ",(0,r.jsx)(n.code,{children:"src/sql/migrations/migrator.ts"})," for more."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["Back to: ",(0,r.jsx)(n.a,{href:"/hysteria-orm/databases/sql/cli/migrations/basics",children:"Migrations Basics"})]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>c});var s=i(6540);const r={},l=s.createContext(r);function o(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);